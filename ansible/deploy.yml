---
##################
# Install Legion Jenkins
##################

# NOTICE:
# You Must specify the next variables as extra vars (--extra-vars "XXXX=YYYY") 
# profile - unique cluster name
# legion_jenkins_version - Legion jenkins version to deploy
# legion_version - Legion version for model pods on jenkins
# pypi_repo - pypi repo endpoint
# Optional arguments:
# docker_repo - rewrite docker registry endpoint


- hosts: localhost
  connection: local
  gather_facts: True

  vars_files:
    - vars/common.yaml

  pre_tasks:
    - name: Download secrets from S3
      aws_s3:
        bucket: "{{ secrets_bucket }}"
        object: "vault/{{ profile }}"
        dest: "{{ secrets_file }}"
        mode: get

    - name: Include vars
      include_vars:
        file: "{{ secrets_file }}"

  post_tasks:
    - name: Delete secrets file
      file:
        name: "{{ secrets_file }}"
        state: absent
  
  roles:
    - charts_common
    - helm
    - jenkins
