FROM ubuntu:18.04

ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /opt/legion/

# install system utilities
RUN apt-get update && apt-get install -y \
    python-pip apt-transport-https bash curl tar openssh-client \
    sshpass git ca-certificates python-pip apt-utils wget locales && \
    apt-get clean -y && apt-get autoclean -y

# setup locale
COPY containers/ansible/default_locale /etc/default/locale
RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8 && \
    chmod 0755 /etc/default/locale

ENV LC_ALL="en_US.UTF-8" \
    LANG="en_US.UTF-8" \
    LANGUAGE="en_US.UTF-8"

# Install ansible from pip
RUN pip install ansible==2.7.2

 # Install ansible dependenciesÐ¾
RUN apt-get install -y \
    python-yaml=3.12-1build2 python-jinja2=2.10-1 python-boto=2.44.0-1ubuntu2 python-boto3=1.4.2-1 \
    python-psycopg2=2.7.4-1 postgresql-client=10+190 python-crypto=2.6.1-8ubuntu2 \
    python-cryptography=2.1.4-1ubuntu1.2 awscli=1.14.44-1ubuntu1 && \
    apt-get clean -y && apt-get autoclean -y

# Configure ansible
RUN mkdir -p /etc/ansible/ && /bin/echo -e "[local]\nlocalhost ansible_connection=local" > /etc/ansible/hosts

# Install Kops
ENV KOPS_VERSION=1.10.0
RUN wget https://github.com/kubernetes/kops/releases/download/${KOPS_VERSION}/kops-linux-amd64 -o /usr/local/bin/kops && \
    chmod a+x /usr/local/bin/kops

# Install kubectl
ENV KUBECTL_VERSION=v1.10.6
RUN wget https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl && \
    chmod a+x /usr/local/bin/kubectl

# Install Helm
ENV HELM_VERSION=v2.10.0
RUN curl -fsSLO https://kubernetes-helm.storage.googleapis.com/helm-${HELM_VERSION}-linux-amd64.tar.gz && \
    mkdir -p /tmp/helm && mv helm-${HELM_VERSION}-linux-amd64.tar.gz /tmp/helm && \
    tar xzf /tmp/helm/helm-${HELM_VERSION}-linux-amd64.tar.gz -C /tmp/helm && \
    mv /tmp/helm/linux-amd64/helm /usr/local/bin/helm && rm -rf /tmp/helm

COPY ansible /opt/legion/ansible
